
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Recipes &#8212; miros-xml 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Quick Start" href="quickstart.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <blockquote id="recipes">
<div><p><em>I’m writing these docs to help myself understand how to build an XML-to-miros parser.</em></p>
</div></blockquote>
<div class="section" id="recipes-recipes">
<span id="id1"></span><h1><a class="toc-backref" href="#id2">Recipes</a><a class="headerlink" href="#recipes-recipes" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#recipes-recipes" id="id2">Recipes</a></p>
<ul>
<li><p><a class="reference internal" href="#summary" id="id3">Summary</a></p></li>
<li><p><a class="reference internal" href="#context-and-terminology" id="id4">Context and Terminology</a></p></li>
<li><p><a class="reference internal" href="#reflection-and-logging" id="id5">Reflection and Logging</a></p>
<ul>
<li><p><a class="reference internal" href="#souped-up-spy" id="id6">Souped Up Spy</a></p></li>
<li><p><a class="reference internal" href="#souped-up-state-name-reflection" id="id7">Souped Up State Name Reflection</a></p></li>
<li><p><a class="reference internal" href="#simplifying-the-inner-injector-functions" id="id8">Simplifying the Inner Injector Functions</a></p></li>
<li><p><a class="reference internal" href="#reading-the-log-file" id="id9">Reading the Log File</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#building-a-subregion" id="id10">Building a Subregion</a></p></li>
<li><p><a class="reference internal" href="#writing-wtf-events-across-regions" id="id11">Writing WTF Events Across Regions</a></p>
<ul>
<li><p><a class="reference internal" href="#e-wtf-events" id="id12">E WTF Events</a></p></li>
<li><p><a class="reference internal" href="#e0-wtf-event" id="id13">E0 WTF Event</a></p></li>
<li><p><a class="reference internal" href="#e1-wtf-event" id="id14">E1 WTF Event</a></p></li>
<li><p><a class="reference internal" href="#e2-wtf-event" id="id15">E2 WTF Event</a></p></li>
<li><p><a class="reference internal" href="#c-wtf-events" id="id16">C WTF Events</a></p></li>
<li><p><a class="reference internal" href="#c0-wtf-event" id="id17">C0 WTF Event</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#hidden-dynamics" id="id18">Hidden Dynamics</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="summary">
<span id="recipes-summary"></span><h2><a class="toc-backref" href="#id3">Summary</a><a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>I wrote this document to help me think through my problems and to try and find a
more straightforward way to implement the parallel tag.</p>
<p>I want miros-XML to support parallel statecharts using the dashed line, as
described by David Harel’s notation. The miros library uses an event dispatching
algorithm developed by Miro Samek. This event dispatching algorithm does
not support the Parallel statechart (orthogonal regions). However, Miro Samek
offered an alternative and faster pattern, the <a class="reference external" href="https://aleph2c.github.io/miros/patterns.html#patterns-orthogonal-component">orthogonal component</a>; an HSM
within an HSM. The problem with this orthogonal component pattern is that it
isn’t as graphically elegant as the one envisioned by David Harel. So the
statechart community expects to use orthogonal regions. David Harel’s graphical
abstractions permit more than one active state to exist within one diagram at a
time; the packing of design complexity into a small diagram’s space is very
efficient. The trade-off is you waste a lot of computer cycles when you design
this way.
If you haven’t seen orthogonal regions before, refer to <a class="reference external" href="https://aleph2c.github.io/miros/othogonalregions.html">this document on
orthogonal regions and miros.</a>.</p>
<p>In this project and these documents, I will be writing about how to have one
orthogonal region communicate with another. My implementation of orthogonal
regions will be a mapping of Miros Samek’s orthogonal component pattern onto a
design that will look and behave like an orthogonal region. This work will be
done by recursively mapping orthogonal components within a chart. An outer
region will <code class="docutils literal notranslate"><span class="pre">dispatch</span></code> events into a deeper or inner region. The outer region
which injects an event will be called an Injector and the region which receives
the events will be called an Injectee. An HSM can both be an Injector and an
Injectee, and the outermost chart will only be an Injector.</p>
<a class="reference external image-reference" href="_static/hidden_dynamics.pdf"><img alt="_images/hidden_dynamics.svg" class="align-center" src="_images/hidden_dynamics.svg" /></a>
<p>The chart will be run within the outermost HSM’s thread, and the inner regions
will be driven by dispatching events and driving them through the orthogonal
component with the <code class="docutils literal notranslate"><span class="pre">complete_circuit</span></code> method.</p>
<p>To manifest transitions between regions, the queue of the various components
will be treated as call stacks into which instructions can be placed.  Otherwise
the majority of the chart will behave using the dynamics of the miros algorithm.</p>
<p>This document is being written so that I can invent enough theory and give
myself enough instruction so as to generalize the construction of any orthogonal
region, described by an XML document, within its <code class="docutils literal notranslate"><span class="pre">&lt;parallel&gt;</span></code> tag.</p>
</div>
<div class="section" id="context-and-terminology">
<span id="recipes-context-and-terminology"></span><h2><a class="toc-backref" href="#id4">Context and Terminology</a><a class="headerlink" href="#context-and-terminology" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is something cluttered about the terminology, come back and pull
things apart so that each thing has one meaning.</p>
</div>
</div></blockquote>
<hr class="docutils" />
<blockquote>
<div><dl>
<dt>Region</dt><dd><p>HsmWithQueues object with additional supporting methods; in the software, it is
represented as a class. In the design, it is an orthogonal component called the
injectee. In statechart theory, the orthogonal region is one of the areas
partitioned within a dashed line. It and its other regions are expected to run
concurrently.</p>
<a class="reference external image-reference" href="_static/region.pdf"><img alt="_images/region.svg" class="align-center" src="_images/region.svg" /></a>
</dd>
<dt>Regions</dt><dd><p>Regions contain multiple Region objects in a collection. It augments the regions
so that they can reference one another using iterators. It adds a _post_fifo and
_post_lifo method, which can put items into all of its inner region’s queues.</p>
<p>It adds a post_fifo and post_lifo method, which will post items onto an internal
queue, then drive the inner statecharts using their complete_circuit method
until their queues are empty.</p>
<a class="reference external image-reference" href="_static/regions.pdf"><img alt="_images/regions.svg" class="align-center" src="_images/regions.svg" /></a>
<p>All other inner state methods, connected to a particular regions HSM
will have an <code class="docutils literal notranslate"><span class="pre">&#64;p_spy_on</span></code> decorator.</p>
</dd>
<dt>XmlChart</dt><dd><p>Is the main statechart into which all events are posted.  It is the
outer most injector.</p>
<a class="reference external image-reference" href="_static/XmlChart.pdf"><img alt="_images/XmlChart.svg" class="align-center" src="_images/XmlChart.svg" /></a>
<p>The XmlChart will have a dict containing multiple Regions.  The
XmlChart’s thread will drive the entire collection of orthogonal
regions.  It will inject all of the events, via the regions dictionary.</p>
<p>All of the XmlChart connected state methods will have a <code class="docutils literal notranslate"><span class="pre">&#64;spy_on</span></code>
decorator.  All other inner state methods will have an <code class="docutils literal notranslate"><span class="pre">&#64;p_spy_on</span></code>
decorator.</p>
</dd>
<dt>Injector:</dt><dd><p>A statechart or orthogonal component which posts events into an inner orthogonal
component then drives the events through the region that injector encapsulates.
The injector places events and drives events using the _post_fifo’, post_fifo …
APIs. The <code class="docutils literal notranslate"><span class="pre">p</span></code> and <code class="docutils literal notranslate"><span class="pre">pp12</span></code> states are both injectors in the following diagram:</p>
<a class="reference external image-reference" href="_static/hidden_dynamics.pdf"><img alt="_images/hidden_dynamics.svg" class="align-center" src="_images/hidden_dynamics.svg" /></a>
</dd>
<dt>Injectee:</dt><dd><blockquote>
<div><p>An orthogonal component who’s events are given to it and driven through it
by an injector. An injectee can also be an injector if it drives another
state. An injector is hidden from view in the main statechart picture with
the dashed lines. However, you can see it at the bottom right of this
picture.</p>
</div></blockquote>
<a class="reference external image-reference" href="_static/hidden_dynamics.pdf"><img alt="_images/hidden_dynamics.svg" class="align-center" src="_images/hidden_dynamics.svg" /></a>
</dd>
<dt>WTF events</dt><dd><p>Any event which crosses between regions.  See <code class="docutils literal notranslate"><span class="pre">E0</span></code>, <code class="docutils literal notranslate"><span class="pre">E1</span></code> and <code class="docutils literal notranslate"><span class="pre">E3</span></code>
in the following diagram</p>
<a class="reference external image-reference" href="_static/hidden_dynamics.pdf"><img alt="_images/hidden_dynamics.svg" class="align-center" src="_images/hidden_dynamics.svg" /></a>
<p>The WTF events are not supported within the miros event processing
algorithim.  This document was written, largely to understand how to
implement these events for the miros-xml parser.</p>
</dd>
<dt>Under Hidden States</dt><dd><p>The outer state of an <strong>injectee</strong>.  It presents the illusion that a
region can be exited.  It’s a holding state with no initialization
handler, and it is the bottom state of the HSM mapped to that region.</p>
</dd>
<dt>Region States</dt><dd><p>This state is sandwiched between the under and outer hidden states.  It
contains a <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> handler which calls the <code class="docutils literal notranslate"><span class="pre">init_stack</span></code>
method which is used for managing <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> events (events which
contain events and states to initialize to).  The region state also has
a <code class="docutils literal notranslate"><span class="pre">region_exit</span></code> event handler which will cause the region to
transition the <strong>under hidden region</strong>.</p>
</dd>
<dt>Over Hidden States</dt><dd><p>This state is above the region state and its purpose to to catch the
<code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> event, which will force a transition to the
region, and thereby force a call of the <code class="docutils literal notranslate"><span class="pre">init_state</span></code> method.</p>
</dd>
<dt>META_INIT</dt><dd><p>An event which contains 0 or more META_INIT events and the state which
are intended to handle the event.  They are injected into the queue of
inner states so that the inner state’s <code class="docutils literal notranslate"><span class="pre">init_stack</span></code> methods can
programmatically initialize their region.</p>
</dd>
<dt>META_EXIT</dt><dd><p>An event which permits a WTF exit strategy</p>
</dd>
<dt>META_SIGNAL_PAYLOAD</dt><dd><p>The payload of a META event.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">META_SIGNAL_PAYLOAD</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
   <span class="s2">&quot;META_SIGNAL_PAYLOAD&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;source_event&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="reflection-and-logging">
<span id="recipes-reflection-and-logging"></span><h2><a class="toc-backref" href="#id5">Reflection and Logging</a><a class="headerlink" href="#reflection-and-logging" title="Permalink to this headline">¶</a></h2>
<div class="section" id="souped-up-spy">
<span id="recipes-suped-up-spy"></span><h3><a class="toc-backref" href="#id6">Souped Up Spy</a><a class="headerlink" href="#souped-up-spy" title="Permalink to this headline">¶</a></h3>
<p>It would be almost impossible to tackle this problem without the spy
instrumentation.  To get the spy instrumentation working within the orthogonal
regions I wrote this wrapper and placed it above each region or state within a
region:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">p_spy_on</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
   <span class="sd">&#39;&#39;&#39;spy wrapper for the parallel regions states</span>

<span class="sd">     **Args**:</span>
<span class="sd">        | ``fn`` (function): the state function</span>
<span class="sd">     **Returns**:</span>
<span class="sd">        (function): wrapped function</span>
<span class="sd">     **Example(s)**:</span>

<span class="sd">     .. code-block:: python</span>

<span class="sd">        @p_spy_on</span>
<span class="sd">        def example(p, e):</span>
<span class="sd">         status = return_status.UNHANDLED</span>
<span class="sd">         return status</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">_pspy_on</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="n">status</span> <span class="o">=</span> <span class="n">spy_on</span><span class="p">(</span><span class="n">fn</span><span class="p">)(</span><span class="n">chart</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">rtc</span><span class="o">.</span><span class="n">spy</span><span class="p">):</span>
<span class="hll">         <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
           <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="s2">&quot;outmost&quot;</span><span class="p">):</span>
             <span class="n">chart</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span>
               <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
           <span class="k">else</span><span class="p">:</span>
             <span class="n">chart</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span>
               <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
       <span class="n">chart</span><span class="o">.</span><span class="n">rtc</span><span class="o">.</span><span class="n">spy</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
     <span class="k">else</span><span class="p">:</span>
       <span class="n">e</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
       <span class="n">status</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>
   <span class="k">return</span> <span class="n">_pspy_on</span>
</pre></div>
</td></tr></table></div>
<p>You can see on line 22 I have filtered out any spy line with the name
<code class="docutils literal notranslate"><span class="pre">SEARCH_FOR_SUPER</span></code>.  This was to reduce the amount of noise in the
instrumentation.</p>
<p>The spy itself is written to a log file and/or written to the terminal.</p>
</div>
<div class="section" id="souped-up-state-name-reflection">
<span id="recipes-suped-up-state-name-reflection"></span><h3><a class="toc-backref" href="#id7">Souped Up State Name Reflection</a><a class="headerlink" href="#souped-up-state-name-reflection" title="Permalink to this headline">¶</a></h3>
<p>If you use the vanilla <code class="docutils literal notranslate"><span class="pre">state_name</span></code> method provided within miros you will only
be able to see the outer most state holding the orthogonal regions; but it will
not reach into this collection of orthogonal regions and report on the active state
of each of them.</p>
<p>To see all of the active states at once using the <code class="docutils literal notranslate"><span class="pre">active_states</span></code> method of
the <code class="docutils literal notranslate"><span class="pre">XmlChart</span></code> class.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="align-center" src="_images/xml_chart_4.svg" /></a>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">example</span> <span class="o">=</span> <span class="n">XmlChart</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;parallel&#39;</span><span class="p">,</span>
  <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;/mnt/c/github/miros-xml/experiment/parallel_example_4.log&quot;</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
  <span class="n">live_spy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">example</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">example</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_p</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">active_states</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">active_states</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&gt;10}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;to_p&quot;</span><span class="p">,</span> <span class="n">active_states</span><span class="p">))</span>
<span class="hll"><span class="k">assert</span> <span class="n">active_states</span> <span class="o">==</span> <span class="p">[[</span><span class="s1">&#39;p_p11_s11&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span>
</span></pre></div>
</td></tr></table></div>
<p>In the above listing we see how the chart is created, started and how you can
send a <code class="docutils literal notranslate"><span class="pre">to_p</span></code> event into it, then we ask it for its active states.  We see it
reports <code class="docutils literal notranslate"><span class="pre">[['p_p11_s11',</span> <span class="pre">'p_p11_s21'],</span> <span class="pre">'p_s21']</span></code>, which describes all of it’s
current states and some regional information by having nested lists.  The
outermost list represents the whole chart and the inner list represents that
<code class="docutils literal notranslate"><span class="pre">p_p11_s11</span></code> and <code class="docutils literal notranslate"><span class="pre">p_p11_s21</span></code> are within a parallel region.</p>
<p>To code required to make <code class="docutils literal notranslate"><span class="pre">active_states</span></code> is within the <code class="docutils literal notranslate"><span class="pre">XmlChart</span></code> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">active_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

  <span class="n">parallel_state_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">recursive_get_states</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parallel_state_names</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_regions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">state_name</span> <span class="ow">in</span> <span class="n">parallel_state_names</span><span class="p">:</span>
          <span class="n">_states</span> <span class="o">=</span> <span class="n">recursive_get_states</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
          <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_states</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">states</span>

  <span class="n">states</span> <span class="o">=</span> <span class="n">recursive_get_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">states</span>
</pre></div>
</div>
</div>
<div class="section" id="simplifying-the-inner-injector-functions">
<span id="recipes-simplifying-the-inner-injector-functions"></span><h3><a class="toc-backref" href="#id8">Simplifying the Inner Injector Functions</a><a class="headerlink" href="#simplifying-the-inner-injector-functions" title="Permalink to this headline">¶</a></h3>
<p>The inner regions will need to access XmlChart methods and attributes to work.</p>
<p>The spy scribble method will be contained in the XmlChart object.  It will need
to be accessed by state functions used by the inner regions.  The <code class="docutils literal notranslate"><span class="pre">outmost</span></code>
attribute can be used to access any item of the XmlChart object from within an
inner Region object.</p>
<p>Here is an example of how to post to the fifo of the <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> region from
anywhere within the state chart.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">region</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">some_signal</span><span class="p">))</span>
</pre></div>
</div>
<p>The region accesses the outmost part of itself, the XmlChart object, then
accesses its regions dict with the ‘p_p11’ key, then post to that subregion’s
post_fifo queu, the drives that event through that orthogonal region before
returning control back to the program.  There is a lot going on, but it is very
noisy.</p>
<p>Consider how we would use a the spy scribble within an inner region:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
  <span class="n">region</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">string</span><span class="p">))</span>
</pre></div>
</div>
<p>There are common functions that will be called over and over again within the
inner region’s injectors and to tighten up the code an
<code class="docutils literal notranslate"><span class="pre">outmost_region_functions</span></code> function writer was made.  It looks like this:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">outmost_region_functions</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">region_name</span><span class="p">):</span>

   <span class="n">outmost</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">outmost</span>
   <span class="k">def</span> <span class="nf">scribble</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="n">string</span><span class="p">))</span>

   <span class="n">post_fifo</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="n">outmost</span><span class="p">)</span>
   <span class="n">_post_fifo</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="n">outmost</span><span class="p">)</span>
   <span class="n">post_lifo</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="n">outmost</span><span class="p">)</span>
   <span class="n">_post_lifo</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span><span class="o">.</span><span class="n">_post_lifo</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="n">outmost</span><span class="p">)</span>
   <span class="n">token_match</span> <span class="o">=</span> <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span>
   <span class="k">return</span> <span class="n">post_fifo</span><span class="p">,</span> <span class="n">_post_fifo</span><span class="p">,</span> <span class="n">post_lifo</span><span class="p">,</span> <span class="n">_post_lifo</span><span class="p">,</span> <span class="n">token_match</span><span class="p">,</span> <span class="n">scribble</span>
</pre></div>
</td></tr></table></div>
<p>The functools partial method is used to prefill arguments to the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code>,
<code class="docutils literal notranslate"><span class="pre">_post_fifo</span></code>, <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code>, <code class="docutils literal notranslate"><span class="pre">_post_lifo</span></code> and <code class="docutils literal notranslate"><span class="pre">token_match</span></code> methods.  A
custom <code class="docutils literal notranslate"><span class="pre">scribble</span></code> function is written and returned as well.</p>
<p>On line 1 we see that the result is cashed to speed up calls the
<code class="docutils literal notranslate"><span class="pre">outmost_region_functions</span></code>.</p>
<p>At the top of any injector you will see this <code class="docutils literal notranslate"><span class="pre">outmost_region_functions</span></code>,
function builder used like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="c1"># ..</span>
  <span class="p">(</span><span class="n">post_fifo</span><span class="p">,</span>
   <span class="n">_post_fifo</span><span class="p">,</span>
   <span class="n">post_lifo</span><span class="p">,</span>
   <span class="n">_post_lifo</span><span class="p">,</span>
   <span class="n">token_match</span><span class="p">,</span>
   <span class="n">scribble</span><span class="p">)</span> <span class="o">=</span> <span class="n">outmost_region_functions</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;p_p11&#39;</span><span class="p">)</span>

   <span class="c1"># inner region&#39;s state function code here</span>
</pre></div>
</div>
</div>
<div class="section" id="reading-the-log-file">
<span id="recipes-reading-the-log-file"></span><h3><a class="toc-backref" href="#id9">Reading the Log File</a><a class="headerlink" href="#reading-the-log-file" title="Permalink to this headline">¶</a></h3>
<p>The XmlChart contains the thread which drives the parallel processes.  It can
push events through each of the inner orthogonal components with calls to the
<code class="docutils literal notranslate"><span class="pre">complete_circuit</span></code> method of each region.  However, this makes reading the
logs a bit confusing, since an orthogonal region’s actions appear to occur
before XmlChart event handling which drove those actions in the first place.
This should become a bit more clear with an example, consider the following log
snippet:</p>
<div class="highlight-log notranslate"><div class="highlight"><pre><span></span> S: [x] to_p:outer_state
 S: [x] [p] ENTRY_SIGNAL
 S: [x] [p_r1] enter_region:p_r1_under_hidden_region
 S: [x] [p_r1] ENTRY_SIGNAL:p_r1_region
 S: [x] [p_r1] INIT_SIGNAL:p_r1_region
 S: [x] [p_r1] ENTRY_SIGNAL:p_r1_over_hidden_region
 S: [x] [p_p11] ENTRY_SIGNAL
 S: [x] [p_p11_r1] enter_region:p_p11_r1_under_hidden_region
 S: [x] [p_p11_r1] ENTRY_SIGNAL:p_p11_r1_region
 S: [x] [p_p11_r1] INIT_SIGNAL:p_p11_r1_region
 S: [x] [p_p11_r1] ENTRY_SIGNAL:p_p11_r1_over_hidden_region
 S: [x] [p_p11_r1] ENTRY_SIGNAL:p_p11_s11
 S: [x] [p_p11_r1] INIT_SIGNAL:p_p11_s11
 S: [x] [p_p11_r2] enter_region:p_p11_r2_under_hidden_region
 S: [x] [p_p11_r2] ENTRY_SIGNAL:p_p11_r2_region
 S: [x] [p_p11_r2] INIT_SIGNAL:p_p11_r2_region
 S: [x] [p_p11_r2] ENTRY_SIGNAL:p_p11_r2_over_hidden_region
 S: [x] [p_p11_r2] ENTRY_SIGNAL:p_p11_s21
 S: [x] [p_p11_r2] INIT_SIGNAL:p_p11_s21
 S: [x] [p_r1] ENTRY_SIGNAL:p_p11
 S: [x] [p_r1] INIT_SIGNAL:p_p11
 S: [x] [p_r2] enter_region:p_r2_under_hidden_region
 S: [x] [p_r2] ENTRY_SIGNAL:p_r2_region
 S: [x] [p_r2] INIT_SIGNAL:p_r2_region
 S: [x] [p_r2] ENTRY_SIGNAL:p_r2_over_hidden_region
 S: [x] [p_r2] ENTRY_SIGNAL:p_s21
 S: [x] [p_r2] INIT_SIGNAL:p_s21
<span class="hll"> S: [x] to_p:outer_state
</span><span class="hll"> S: [x] SEARCH_FOR_SUPER_SIGNAL:p
</span><span class="hll"> S: [x] ENTRY_SIGNAL:p
</span><span class="hll"> S: [x] INIT_SIGNAL:p
</span><span class="hll"> S: [x] &lt;- Queued:(0) Deferred:(0)
</span> R:
 [&#39;outer_state&#39;] &lt;- to_p == [[&#39;p_p11_s11&#39;, &#39;p_p11_s21&#39;], &#39;p_s21&#39;]
</pre></div>
</div>
<p>The highlighted code describes event handling of the XmlChart which drove the
actions seen above that part of the listing.  The output of the R: tells us how
this happened in the first place.  The system was in a <code class="docutils literal notranslate"><span class="pre">outer_state</span></code> then it
received a <code class="docutils literal notranslate"><span class="pre">to_p</span></code> event, which caused it to enter a number of parallel states,
<code class="docutils literal notranslate"><span class="pre">[['p_p11_s11',</span> <span class="pre">'p_p11_s21'],</span> <span class="pre">'p_s21']</span></code>.  To see how this happened, you would
read the logs before the highlighted section.</p>
<p>With enough effort I would make the log file linear in time, but it might not be
worth the effort.</p>
</div>
</div>
<div class="section" id="building-a-subregion">
<span id="recipes-building-a-subregion"></span><h2><a class="toc-backref" href="#id10">Building a Subregion</a><a class="headerlink" href="#building-a-subregion" title="Permalink to this headline">¶</a></h2>
<p>We will build <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> in the following diagram:</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="align-center" src="_images/xml_chart_4.svg" /></a>
<p>To build the <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> subregion you will need to:</p>
<ol class="arabic simple">
<li><p>Create an injector:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">outmost</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">init_stack</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for INIT_META</span>
    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
    <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="c1"># any event handled within there regions must be pushed from here</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;F1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;G3&quot;</span><span class="p">)</span>
      <span class="p">):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span>
    <span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p12</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;C0&quot;</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p12</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">META_EXIT</span><span class="p">):</span>
    <span class="n">region1</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get_region</span><span class="p">()</span>
    <span class="n">region2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get_region</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">region1</span> <span class="o">==</span> <span class="n">region2</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span> <span class="ow">or</span>
       <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">region_exit</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">region_exit</span><span class="p">)))</span>
    <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">region_exit</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">p_r1_over_hidden_type</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>2. Create the injectee states.  These are the under_hidden, region, and over_hidden state for
that subregion of the orthogonal component which behaves like a subregion:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11_r1_under_hidden_region</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;enter_region&quot;</span><span class="p">)):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_r1_region</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">rr</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11_r1_region</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">init_stack</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for INIT_META</span>
    <span class="c1"># if _state is a child of this state then transition to it</span>
    <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rr</span><span class="o">.</span><span class="n">has_a_child</span><span class="p">(</span><span class="n">_state</span><span class="p">):</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_s11</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rr</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">region_exit</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_r1_under_hidden_region</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_META</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">rr</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">p_p11_r1_under_hidden_region</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11_r1_over_hidden_region</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span><span class="o">==</span><span class="n">signals</span><span class="o">.</span><span class="n">force_region_init</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_r1_region</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">rr</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">p_p11_r1_region</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11_s11</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_s12</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">rr</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">p_p11_r1_over_hidden_region</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="c1"># ..</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Ensure all signals which are passed into the region are injected by outer injectors:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">outmost</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">init_stack</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for INIT_META</span>
    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
    <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="c1"># any event handled within there regions must be pushed from here</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;F1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;G3&quot;</span><span class="p">)</span>
      <span class="p">):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Add the region to the XmlChart’s regions dict within the XmlChart
<code class="docutils literal notranslate"><span class="pre">__init__</span></code> method:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Regions</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p_p11&#39;</span><span class="p">,</span>
  <span class="n">outmost</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>\
<span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;p_p11_r1&#39;</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="n">outer</span><span class="p">)</span>\
<span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;p_p11_r2&#39;</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="n">outer</span><span class="p">)</span><span class="o">.</span><span class="n">link</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-wtf-events-across-regions">
<span id="recipes-writing-wtf-events-across-regions"></span><h2><a class="toc-backref" href="#id11">Writing WTF Events Across Regions</a><a class="headerlink" href="#writing-wtf-events-across-regions" title="Permalink to this headline">¶</a></h2>
<p>This section will contain the recipes needed to construct the blue <code class="docutils literal notranslate"><span class="pre">WTF</span></code>
events, or events that span across parallel regions in this example program.
The <code class="docutils literal notranslate"><span class="pre">xml_chart_4</span></code> diagram shown below is based upon the <a class="reference external" href="https://aleph2c.github.io/miros/_static/comprehensive_no_instrumentation.pdf">hsm comprehensive
diagram in the miros project</a>.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="align-center" src="_images/xml_chart_4.svg" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">WTF</span></code> is a backronym and it stands for “Witness The Fitness” (lifted from
my friend Jen Farroll’s <a class="reference external" href="http://www.witnessthefitness.ca">personal training business</a>).</p>
</div>
<div class="section" id="e-wtf-events">
<span id="recipes-e-events"></span><h3><a class="toc-backref" href="#id12">E WTF Events</a><a class="headerlink" href="#e-wtf-events" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">E</span></code> events start at the edge of a parallel region, then go deeper into the
chart.  See <code class="docutils literal notranslate"><span class="pre">E0</span></code>, <code class="docutils literal notranslate"><span class="pre">E1</span></code> and <code class="docutils literal notranslate"><span class="pre">E2</span></code> in the diagram below.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="align-center" src="_images/xml_chart_4.svg" /></a>
<p>The <code class="docutils literal notranslate"><span class="pre">E</span></code> events in the orthogonal component mapping start at an injector, then
are dispatched to all regions managed by that injector.  The <code class="docutils literal notranslate"><span class="pre">E</span></code> event is
caught then turned into a <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> which may contain 0 or more
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> events as payloads within it.  This is explained in detail in the
<code class="docutils literal notranslate"><span class="pre">E0</span></code> section.  The <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> is kind of like an onion event, each layer
corresponding to either an injector or injectee part of the design.</p>
</div>
<div class="section" id="e0-wtf-event">
<span id="recipes-e0-wtf-event"></span><h3><a class="toc-backref" href="#id13">E0 WTF Event</a><a class="headerlink" href="#e0-wtf-event" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">E0</span></code> event occurs from the outer most threaded state chart and it passes over
multiple regional boundaries.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="align-center" src="_images/xml_chart_4.svg" /></a>
<p>This WTF meta event is initially captured in the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># ...</span>
  <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E0&quot;</span><span class="p">)):</span>
    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter outer_state&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:outer_state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="n">_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_init</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">p_p11_s22</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="n">payload_string</span><span class="p">(</span><span class="n">_e</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
  <span class="c1"># ...</span>
</pre></div>
</div>
<p>To build a state chart and send it an <code class="docutils literal notranslate"><span class="pre">E0</span></code> event, you would type the
following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">example</span> <span class="o">=</span> <span class="n">XmlChart</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
  <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;/mnt/c/github/miros-xml/experiment/parallel_example_4.log&quot;</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
  <span class="n">live_spy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">example</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="s2">&quot;E0&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>To see what happens we can view the log:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E0</span><span class="p">:</span><span class="n">outer_state</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">POST_FIFO</span><span class="p">:</span><span class="n">META_INIT</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p11_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p11_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s22</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s22</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
<span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E0</span><span class="p">:</span><span class="n">outer_state</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
</span><span class="hll"> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p</span> <span class="n">at</span> <span class="mh">0x7f5d25d526a8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">    <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_r1_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d496a8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">       <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11</span> <span class="n">at</span> <span class="mh">0x7f5d25d498c8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">          <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r2_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b1e0</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">             <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s22</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b510</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">POST_FIFO</span><span class="p">:</span><span class="n">META_INIT</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</span> <span class="n">R</span><span class="p">:</span>
 <span class="p">[</span><span class="s1">&#39;outer_state&#39;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">E0</span> <span class="o">==</span> <span class="p">[[</span><span class="s1">&#39;p_p11_s11&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s22&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span>
</pre></div>
</div>
<hr class="docutils" />
<p><strong>Analysis:</strong></p>
<p>We see at the bottom of the log (highlighted) how the <code class="docutils literal notranslate"><span class="pre">E0</span></code> creates a
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event which contains other <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> events.</p>
<p>The key to understanding how the transitions occur is to track this
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event from the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code> to the <code class="docutils literal notranslate"><span class="pre">p_p11_s22</span></code> state.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="c1"># ...</span>
   <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E0&quot;</span><span class="p">)):</span>
     <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter outer_state&quot;</span><span class="p">)</span>
     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:outer_state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
<span class="hll">     <span class="n">_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_init</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">p_p11_s22</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
</span>     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="n">payload_string</span><span class="p">(</span><span class="n">_e</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
   <span class="c1"># ...</span>
</pre></div>
</td></tr></table></div>
<p>On line 9 meta_init is used to create the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code>.  As of line 9:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">p</span>
<span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span>
   <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_r1_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d496a8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
      <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11</span> <span class="n">at</span> <span class="mh">0x7f5d25d498c8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
         <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r2_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b1e0</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
            <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s22</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b510</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>On line 10 <code class="docutils literal notranslate"><span class="pre">_e</span></code>’s contents are injected into the log which we can see in the
previous listing.  On line 11, we place <code class="docutils literal notranslate"><span class="pre">_e.payload.event</span></code> into the fifo of
our XmlChart statechart.  On line 12 we transition to <code class="docutils literal notranslate"><span class="pre">_e.payload.state</span></code> (<code class="docutils literal notranslate"><span class="pre">p</span></code>).</p>
<p>Let’s look at the important part of the <code class="docutils literal notranslate"><span class="pre">p</span></code> state function:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;[p] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
<span class="hll">    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_stack</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
</span>    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter p&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">),</span> <span class="n">outmost</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
 <span class="c1"># ..</span>
</pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal notranslate"><span class="pre">p</span></code> function is the first injector.  We see on line 2 the word <code class="docutils literal notranslate"><span class="pre">self</span></code>,
which by convention, tells us we are in a thread connected statechart and not a
orthogonal-region’s HSM.</p>
<p>On line 9 we see that the next event and state are stripped off of the
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> which is sitting in the FIFO queue of the XmlChart.  This is an
exotic way to program, very eccentric.  Normally you do not touch the queues,
you let the framework handle this information for you, we are breaking this
rule, and use the queue as a kind of programming callstack.</p>
<p>As of line 9:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_state</span> <span class="o">=</span> <span class="n">p_r1_region</span>
<span class="n">_e</span> <span class="o">=</span> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11</span> <span class="n">at</span> <span class="mh">0x7f5d25d498c8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
       <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r2_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b1e0</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
          <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s22</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b510</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">init_stack</span></code> method looks like this:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> \
    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">META_INIT</span><span class="p">:</span>
<span class="hll">    <span class="n">_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
</span>    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">result</span>
</pre></div>
</td></tr></table></div>
<p>If there is an event on the queue and it is an <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> then we pop it off
the stack.  We do this before the underlying miros framework has a chance to
handle it.  We parasitize the FIFO for our own purpose and the miros framework
is none the wiser for it.</p>
<p>Finally we return the event and the state information on line 7.</p>
<p>Next consider line 10-11 of the <code class="docutils literal notranslate"><span class="pre">p</span></code> listing:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;[p] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_stack</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
<span class="hll">    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
</span><span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span>    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter p&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">),</span> <span class="n">outmost</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
 <span class="c1"># ..</span>
</pre></div>
</td></tr></table></div>
<p>After <code class="docutils literal notranslate"><span class="pre">init_stack</span></code> peals off the first onion layer of our <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event,
we place its inner contents into the <code class="docutils literal notranslate"><span class="pre">p</span></code> subregion’s FIFO using the <code class="docutils literal notranslate"><span class="pre">_post_fifo</span></code> method.</p>
<p>Any posting event with a <code class="docutils literal notranslate"><span class="pre">_</span></code> prepended to it, by convention does not drive the
event through its inner regions, it just posts items onto their queues:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_post_fifo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="p">[</span><span class="n">region</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">p</span></code> region has two sub-regions, <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2</span></code>. The <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> has
these state functions:</p>
<blockquote>
<div><ul class="simple">
<li><p>p_r1_under_hidden_region</p></li>
<li><p>p_r1_region</p></li>
<li><p>p_r1_over_hidden_region</p></li>
<li><p>p_p11 (injector)</p></li>
<li><p>p_p12 (injector)</p></li>
<li><p>p_r1_final</p></li>
</ul>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">p_r2</span></code> has these state functions:</p>
<blockquote>
<div><ul class="simple">
<li><p>p_r2_under_hidden_region</p></li>
<li><p>p_r2_region</p></li>
<li><p>p_r2_over_hidden_region</p></li>
<li><p>p_r2_final</p></li>
<li><p>p_s21</p></li>
<li><p>p_p22 (injector)</p></li>
</ul>
</div></blockquote>
<p>Looking back to <code class="docutils literal notranslate"><span class="pre">p</span></code>, on line 13 we see how META_INIT is driven into the internal regions:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;[p] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_stack</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter p&quot;</span><span class="p">)</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">),</span> <span class="n">outmost</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal notranslate"><span class="pre">p</span></code> region’s queue has a <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event in it, on line 13 we push the
<code class="docutils literal notranslate"><span class="pre">enter_region</span></code> event ahead of it using the <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> event.  This causes
the <code class="docutils literal notranslate"><span class="pre">enter_region</span></code> event to both barge ahead of the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event in
both of the <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2</span></code> queues.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> event does two things, it posts using a lifo technique then
drives all events through the inner regions using the <code class="docutils literal notranslate"><span class="pre">complete_circuit</span></code>
method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">post_lifo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_post_lifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
  <span class="p">[</span><span class="n">region</span><span class="o">.</span><span class="n">complete_circuit</span><span class="p">()</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">]</span>
</pre></div>
</div>
<p>After the <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> call on line 13 of the p listing, there is an
<code class="docutils literal notranslate"><span class="pre">enter_region</span></code> event and a <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event on both the <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> and
<code class="docutils literal notranslate"><span class="pre">p_r2</span></code> orthogonal region queues.  To see what happens we need to look at our
abstract HSM strategy:</p>
<a class="reference external image-reference" href="_static/hidden_dynamics2.pdf"><img alt="_images/hidden_dynamics2.svg" class="align-center" src="_images/hidden_dynamics2.svg" /></a>
<p>An <code class="docutils literal notranslate"><span class="pre">enter_region</span></code> causes the transitions from <code class="docutils literal notranslate"><span class="pre">p_r1_under_hidden_region</span></code>
and <code class="docutils literal notranslate"><span class="pre">p_r2_under_hidden_region</span></code> to <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code>
respectively.  Then the <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> signal of the <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> and
<code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code> state functions are fired.  To see what happens next we look at
the <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> injectee function:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_r1_region</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># ...</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">init_stack</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
</span><span class="hll">    <span class="c1"># if _state is a child of this state then transition to it</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">has_a_child</span><span class="p">(</span><span class="n">p_r1_region</span><span class="p">,</span> <span class="n">_state</span><span class="p">):</span>
</span><span class="hll">      <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11</span><span class="p">)</span>
</span><span class="hll">    <span class="k">else</span><span class="p">:</span>
</span><span class="hll">      <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span>
</span><span class="hll">      <span class="k">if</span> <span class="ow">not</span> <span class="n">_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span class="hll">        <span class="n">r</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span><span class="hll"> <span class="c1"># ...</span>
</span></pre></div>
</td></tr></table></div>
<p>On line 6 we see another layer is pealed off the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event.  If the
<code class="docutils literal notranslate"><span class="pre">_state</span></code> information isn’t present or the target state is not a child of the
<code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> state then we fall back to our default initialization; if line 8
returns true, the <code class="docutils literal notranslate"><span class="pre">_e</span></code> event is thrown in the garbage and the default behavior
of the initialization occurs.  For this region the default behavior to
transition to <code class="docutils literal notranslate"><span class="pre">p_p11</span></code>.</p>
<p>But line 8 returns false in our situation because:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_state</span> <span class="o">=</span> <span class="n">p_p11</span>
<span class="n">_e</span> <span class="o">=</span> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r2_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b1e0</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
       <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s22</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b510</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>So we transition to the value of <code class="docutils literal notranslate"><span class="pre">_state</span></code>, <code class="docutils literal notranslate"><span class="pre">p_p11</span></code>, and we post <code class="docutils literal notranslate"><span class="pre">_e</span></code> into our fifo and
drive the event through to completion.  Looking back to our log trace we can see
that this <code class="docutils literal notranslate"><span class="pre">_state</span></code> variable would have been <code class="docutils literal notranslate"><span class="pre">p_p11</span></code>, which is the injector
for the next internal region.</p>
<p>So let’s look at that <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> injector.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@p_spy_on</span>
</span><span class="k">def</span> <span class="nf">p_p11</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  r is either p_r1, p_r2 region</span>
<span class="sd">  r.outer = p</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="n">outmost</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span>
  <span class="p">(</span><span class="n">post_fifo</span><span class="p">,</span>
   <span class="n">_post_fifo</span><span class="p">,</span>
   <span class="n">post_lifo</span><span class="p">,</span>
   <span class="n">_post_lifo</span><span class="p">,</span>
   <span class="n">token_match</span><span class="p">,</span>
   <span class="n">scribble</span><span class="p">)</span> <span class="o">=</span> <span class="n">outmost_region_functions</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;p_p11&#39;</span><span class="p">)</span>

  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter p_p11&quot;</span><span class="p">)</span>
    <span class="n">scribble</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">init_stack</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
      <span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="n">outmost</span><span class="p">)</span>
    <span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="c1"># ...</span>
</pre></div>
</td></tr></table></div>
<p>We see the same pattern we saw in the <code class="docutils literal notranslate"><span class="pre">p</span></code> injector.  If there is an
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event waiting in the queue, it is pealed.  If there is <code class="docutils literal notranslate"><span class="pre">_state</span></code>
information in the pealing, remaining part of the event is place into the fifo
of the <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> region, then that region’s state handlers are sent an
<code class="docutils literal notranslate"><span class="pre">enter_region</span></code> event.</p>
<p>As of line 9 the following is true:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_state</span> <span class="o">=</span> <span class="n">p_p11_r2_region</span>
<span class="n">_e</span> <span class="o">=</span> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s22</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b510</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> region has two sub-regions, <code class="docutils literal notranslate"><span class="pre">p_p11_r1</span></code> and <code class="docutils literal notranslate"><span class="pre">p_p11_r2</span></code>.  The
<code class="docutils literal notranslate"><span class="pre">p_p11_r1</span></code> region has these state functions.</p>
<ul class="simple">
<li><p>p_p11_r1_under_hidden_region</p></li>
<li><p>p_p11_r1_region</p></li>
<li><p>p_p11_r1_over_hidden_region</p></li>
<li><p>p_p11_r1_final</p></li>
<li><p>p_p11_s11</p></li>
<li><p>p_p11_s12</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">p_p11_r2</span></code> region has these state functions.</p>
<ul class="simple">
<li><p>p_p11_r2_under_hidden_region</p></li>
<li><p>p_p11_r2_region</p></li>
<li><p>p_p11_r2_over_hidden_region</p></li>
<li><p>p_p11_r2_final</p></li>
<li><p>p_p11_s21</p></li>
<li><p>p_p11_s22</p></li>
</ul>
<a class="reference external image-reference" href="_static/hidden_dynamics2.pdf"><img alt="_images/hidden_dynamics2.svg" class="align-center" src="_images/hidden_dynamics2.svg" /></a>
<p>The same injectee pattern is seen again.  The <code class="docutils literal notranslate"><span class="pre">enter_region</span></code> causes the
transitions from <code class="docutils literal notranslate"><span class="pre">p_p11_r1_under_hidden_region</span></code> and
<code class="docutils literal notranslate"><span class="pre">p_p11_r1_under_hidden_region</span></code> to <code class="docutils literal notranslate"><span class="pre">p_p11_r1_region</span></code> and <code class="docutils literal notranslate"><span class="pre">p_p11_r2_region</span></code>
respectively.  Then the <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> clause of <code class="docutils literal notranslate"><span class="pre">p_p11_r1_region</span></code> and
<code class="docutils literal notranslate"><span class="pre">p_p11_r2_region</span></code> functions are activated.  To see what happens next we look
at the <code class="docutils literal notranslate"><span class="pre">p_p11_r2_region</span></code> injectee function:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11_r2_region</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># ...</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
<span class="hll">    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">init_stack</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
</span>    <span class="c1"># if _state is a child of this state then transition to it</span>
<span class="hll">    <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rr</span><span class="o">.</span><span class="n">has_a_child</span><span class="p">(</span><span class="n">p_p11_r2_region</span><span class="p">,</span> <span class="n">_state</span><span class="p">):</span>
</span>      <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_s21</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
<span class="hll">      <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span>
</span>      <span class="k">if</span> <span class="ow">not</span> <span class="n">_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rr</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
<span class="c1"># ...</span>
</pre></div>
</td></tr></table></div>
<p>As of line 6 the following is true:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_state</span> <span class="o">=</span> <span class="n">p_p11_s22</span>
<span class="n">_e</span>  <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>On line 6 the last layer of the onion is pulled.  The <code class="docutils literal notranslate"><span class="pre">_state</span></code> variable
contains <code class="docutils literal notranslate"><span class="pre">p_p11_s22</span></code> and the <code class="docutils literal notranslate"><span class="pre">_e</span></code> is set to None.  The logic to line 8 does
not apply to <code class="docutils literal notranslate"><span class="pre">p_p11_s22</span></code>, so we call the <code class="docutils literal notranslate"><span class="pre">trans</span></code> method on line 11.</p>
</div>
<div class="section" id="e1-wtf-event">
<span id="recipes-e1-wtf-event"></span><h3><a class="toc-backref" href="#id14">E1 WTF Event</a><a class="headerlink" href="#e1-wtf-event" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">E1</span></code> event is very much like the <code class="docutils literal notranslate"><span class="pre">E0</span></code> event in that it uses a <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event to
pass over multiple boundaries.  It difference from the <code class="docutils literal notranslate"><span class="pre">E0</span></code> event in that the
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> needs to be sent the injector managing an inner orthogonal
component.  This injector is still part of the outer containing statechart.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="align-center" src="_images/xml_chart_4.svg" /></a>
<p>If we start the chart in <code class="docutils literal notranslate"><span class="pre">[['p_p11_s11',</span> <span class="pre">'p_p11_s22'],</span> <span class="pre">'p_s21']</span></code> the post an
<code class="docutils literal notranslate"><span class="pre">E1</span></code> event we will see the following logs:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="n">E1</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">force_region_init</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">force_region_init</span><span class="p">:</span><span class="n">p_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_s22</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s22</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">POST_FIFO</span><span class="p">:</span><span class="n">META_INIT</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p11_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p11_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">force_region_init</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">force_region_init</span><span class="p">:</span><span class="n">p_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
<span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E1</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
</span><span class="hll"> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11</span> <span class="n">at</span> <span class="mh">0x7fb8b27c88c8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">    <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r1_region</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8ae8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">       <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s12</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8e18</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E1</span><span class="p">:</span><span class="n">p</span><span class="p">:</span><span class="n">HOOK</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</span> <span class="n">R</span><span class="p">:</span>
 <span class="p">[[</span><span class="s1">&#39;p_p11_s11&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s22&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">E1</span> <span class="o">==</span> <span class="p">[[</span><span class="s1">&#39;p_p11_s12&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>The workings of the outer statechart are highlighted.  Despite, <code class="docutils literal notranslate"><span class="pre">E1</span></code> being
handled within the <code class="docutils literal notranslate"><span class="pre">p</span></code> region, the code needed to manage it is written in the <code class="docutils literal notranslate"><span class="pre">p</span></code> function which has access the <code class="docutils literal notranslate"><span class="pre">XmlChart</span></code> via the <code class="docutils literal notranslate"><span class="pre">self</span></code> keyword:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
 <span class="c1"># ..</span>
   <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E1&quot;</span><span class="p">)):</span>
     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
<span class="hll">     <span class="n">_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_init</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">p_p11_s22</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">force_region_init</span><span class="p">))</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span></pre></div>
</td></tr></table></div>
<p>On line 8 the meta event is constructed, with a target equal to <code class="docutils literal notranslate"><span class="pre">p_p11_s22</span></code>
and it’s sources state set to <code class="docutils literal notranslate"><span class="pre">p</span></code>.  The event name is passed through into the
method, though it is currently not used.</p>
<p>Line 9, pushes a <code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> into the <code class="docutils literal notranslate"><span class="pre">p</span></code> region’s orthogonal
component’s queue, then on line 10, the meta event is placed and the events are
driven through the orthogonal component by the <code class="docutils literal notranslate"><span class="pre">complete_circuit</span></code> method
within the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> call.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> event will be on the queue before the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code>
event.  The <code class="docutils literal notranslate"><span class="pre">p</span></code> region has two sub-regions, <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2</span></code>. The <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> has
these state functions:</p>
<blockquote>
<div><ul class="simple">
<li><p>p_r1_under_hidden_region</p></li>
<li><p>p_r1_region</p></li>
<li><p>p_r1_over_hidden_region</p></li>
<li><p>p_p11 (injector)</p></li>
<li><p>p_p12 (injector)</p></li>
<li><p>p_r1_final</p></li>
</ul>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">p_r2</span></code> has these state functions:</p>
<blockquote>
<div><ul class="simple">
<li><p>p_r2_under_hidden_region</p></li>
<li><p>p_r2_region</p></li>
<li><p>p_r2_over_hidden_region</p></li>
<li><p>p_r2_final</p></li>
<li><p>p_s21</p></li>
<li><p>p_p22 (injector)</p></li>
</ul>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> will cause the <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> orthogonal component to
transition to <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> and the <code class="docutils literal notranslate"><span class="pre">p_r2</span></code> orthogonal component to
transition to <code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code>.  It does this so that the next event, the
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> waiting in the next spot of the queue will be seen by the
<code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> clause of the <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code> functions:</p>
<a class="reference external image-reference" href="_static/hidden_dynamics2.pdf"><img alt="_images/hidden_dynamics2.svg" class="align-center" src="_images/hidden_dynamics2.svg" /></a>
<p>Both <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code> will now be presented with this
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11</span> <span class="n">at</span> <span class="mh">0x7fb8b27c88c8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
   <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r1_region</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8ae8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
      <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s12</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8e18</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>To see how to successfully trace the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event to its target read the <a class="reference internal" href="#recipes-e0-wtf-event"><span class="std std-ref">E0
recipe</span></a>.  In this case we will examine how the
<code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code>, which is not a target of the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> ditches the event
and behaves in accordance to its default INIT_SIGNAL behavior:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@p_spy_on</span>
 <span class="k">def</span> <span class="nf">p_r2_region</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="c1"># ...</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">init_stack</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
     <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">has_a_child</span><span class="p">(</span><span class="n">p_r2_region</span><span class="p">,</span> <span class="n">_state</span><span class="p">):</span>
       <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_s21</span><span class="p">)</span>
     <span class="k">else</span><span class="p">:</span>
       <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span>
       <span class="c1">#print(&quot;p_r2_region init {}&quot;.format(_state))</span>
       <span class="k">if</span> <span class="ow">not</span> <span class="n">_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">r</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</td></tr></table></div>
<p>On line 7:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_state</span> <span class="o">=</span> <span class="n">p_p11</span>
<span class="n">_e</span> <span class="o">=</span> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r1_region</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8ae8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
      <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s12</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8e18</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>This will cause the <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">r.has_a_child(p_r2_region,</span> <span class="pre">_state)</span></code> to return True,
causing a transition to the <code class="docutils literal notranslate"><span class="pre">p_s21</span></code> state.</p>
</div>
<div class="section" id="e2-wtf-event">
<h3><a class="toc-backref" href="#id15">E2 WTF Event</a><a class="headerlink" href="#e2-wtf-event" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">E2</span></code> event is like the <code class="docutils literal notranslate"><span class="pre">E1</span></code> event in that it uses a <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event
to pass over multiple orthogonal component boundaries.  It differs from the
<code class="docutils literal notranslate"><span class="pre">E1</span></code> event in that its <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> needs to be sent from within an orthogonal
component and not from outer containing statechart.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="align-center" src="_images/xml_chart_4.svg" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">690</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="n">E2</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">693</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">694</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r1_over_hidden_region</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">694</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r1_region</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">695</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r1_under_hidden_region</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">696</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">697</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r2_over_hidden_region</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">697</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r2_region</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">698</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r2_under_hidden_region</span>
<span class="hll"> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">699</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">699</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p</span><span class="p">:</span><span class="n">HOOK</span>
</span><span class="hll"> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">700</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">885</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">R</span><span class="p">:</span>
 <span class="p">[[</span><span class="s1">&#39;p_p11_s12&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">E2</span> <span class="o">==</span> \
 <span class="p">[[</span><span class="s1">&#39;p_p11_s12&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>To make this work, the <code class="docutils literal notranslate"><span class="pre">E2</span></code> must first be injected and driven through the
internal orthogonal components by the outer most injector (<code class="docutils literal notranslate"><span class="pre">p</span></code>):</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="c1"># ..</span>

   <span class="c1"># any event handled within there regions must be pushed from here</span>
   <span class="k">elif</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e3&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e5&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;C0&quot;</span><span class="p">)</span> <span class="ow">or</span>
<span class="hll">       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E2&quot;</span><span class="p">)</span> <span class="ow">or</span>
</span>       <span class="c1"># self.token_match(e.signal_name, &quot;G3&quot;) or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p12&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span><span class="p">)</span>
       <span class="p">)):</span>
     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</pre></div>
</td></tr></table></div>
<p>The construction of its META_INIT event occurs within the <code class="docutils literal notranslate"><span class="pre">p_p12</span></code> handler:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@p_spy_on</span>
 <span class="k">def</span> <span class="nf">p_p12</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="n">outmost</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span>
   <span class="p">(</span><span class="n">post_fifo</span><span class="p">,</span>
    <span class="n">_post_fifo</span><span class="p">,</span>
    <span class="n">post_lifo</span><span class="p">,</span>
    <span class="n">_post_lifo</span><span class="p">,</span>
    <span class="n">token_match</span><span class="p">,</span>
    <span class="n">scribble</span><span class="p">)</span> <span class="o">=</span> <span class="n">outmost_region_functions</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;p_p12&#39;</span><span class="p">)</span>
   <span class="c1"># ..</span>
   <span class="k">elif</span> <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E2&quot;</span><span class="p">):</span>
     <span class="n">scribble</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
<span class="hll">     <span class="n">_e</span> <span class="o">=</span> <span class="n">outmost</span><span class="o">.</span><span class="n">meta_init</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">p_p12_p11_s12</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">p_p12</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
</span><span class="hll">     <span class="c1"># this force_region_init might be a problem</span>
</span><span class="hll">     <span class="n">_post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">force_region_init</span><span class="p">))</span>
</span><span class="hll">     <span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="c1"># ..</span>
</pre></div>
</td></tr></table></div>
<p>On line 14 we create a META_INIT as a reaction to the  <code class="docutils literal notranslate"><span class="pre">E2</span></code> event.  To build
such an <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> we need to specify the target, <code class="docutils literal notranslate"><span class="pre">t</span></code>, the source <code class="docutils literal notranslate"><span class="pre">s</span></code> and
the event’s signals name (E2).  The resulting meta event is returned as <code class="docutils literal notranslate"><span class="pre">_e</span></code>.</p>
<p>On line 10 the first location of each queue of the orthogonal regions of
<code class="docutils literal notranslate"><span class="pre">p_p12</span></code> have the <code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> event posted to their far left location.  On
line 11, the <code class="docutils literal notranslate"><span class="pre">_e</span></code> meta event is placed the right of each
<code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> event for each queue in the <code class="docutils literal notranslate"><span class="pre">p_p12</span></code> region, then all
events are pushed through those machines.</p>
<p>To make the <code class="docutils literal notranslate"><span class="pre">E2</span></code> event work for the entire chart, a handler needs to be added
to <code class="docutils literal notranslate"><span class="pre">p_p22</span></code>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@p_spy_on</span>
 <span class="k">def</span> <span class="nf">p_p22</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="n">outmost</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span>
   <span class="p">(</span><span class="n">post_fifo</span><span class="p">,</span>
    <span class="n">_post_fifo</span><span class="p">,</span>
    <span class="n">post_lifo</span><span class="p">,</span>
    <span class="n">_post_lifo</span><span class="p">,</span>
    <span class="n">token_match</span><span class="p">,</span>
<span class="hll">    <span class="n">scribble</span><span class="p">)</span> <span class="o">=</span> <span class="n">outmost_region_functions</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;p_p22&#39;</span><span class="p">)</span>
</span>   <span class="c1"># ..</span>
   <span class="c1"># any event handled within there regions must be pushed from here</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E2&quot;</span><span class="p">)</span>
       <span class="p">):</span>
     <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p22&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
     <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</pre></div>
</td></tr></table></div>
<p>If <code class="docutils literal notranslate"><span class="pre">E2</span></code> is not permitted to be driven through the <code class="docutils literal notranslate"><span class="pre">p_p22</span></code> the statechart
doesn’t work properly.</p>
</div>
<div class="section" id="c-wtf-events">
<span id="recipes-c-events"></span><h3><a class="toc-backref" href="#id16">C WTF Events</a><a class="headerlink" href="#c-wtf-events" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">C</span></code> events cause a transition from one orthogonal region to another.  The do
not span boundaries:</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="align-center" src="_images/xml_chart_4.svg" /></a>
</div>
<div class="section" id="c0-wtf-event">
<span id="recipes-c0-wtf-event"></span><h3><a class="toc-backref" href="#id17">C0 WTF Event</a><a class="headerlink" href="#c0-wtf-event" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">C0</span></code> event occurs within one or more orthogonal regions.   The basic
pattern involves the outer states letting the <code class="docutils literal notranslate"><span class="pre">C0</span></code> enter into its required
depth, then a region’s injector captures the event and uses the miros <code class="docutils literal notranslate"><span class="pre">trans</span></code> call
to cause the transition.  It does not require META events to manage its
transition across boundaries and is thereby the simplest <code class="docutils literal notranslate"><span class="pre">WTF</span></code> event.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="align-center" src="_images/xml_chart_4.svg" /></a>
<p>Suppose the chart was in a <code class="docutils literal notranslate"><span class="pre">[['p_p11_s12',</span> <span class="pre">'p_p11_s21'],</span> <span class="pre">'p_s21']</span></code> combination
of states and a <code class="docutils literal notranslate"><span class="pre">C0</span></code> was sent to the chart.  The log file would look like
this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="n">C0</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">C0</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_s12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p12_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p12_p11_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p12_p11_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p12_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">C0</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p22_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p22_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p22_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p22_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p22</span>
<span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">C0</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">C0</span><span class="p">:</span><span class="n">p</span><span class="p">:</span><span class="n">HOOK</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</span> <span class="n">R</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;p_p11_s12&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">C0</span> <span class="o">==</span> \
 <span class="p">[[[</span><span class="s1">&#39;p_p12_p11_s11&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p12_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_p12_s21&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;p_p22_s11&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p22_s21&#39;</span><span class="p">]]</span>
</pre></div>
</div>
<p>The highlighted parts of the log cause the upper part of the log to take place.</p>
</div>
</div>
<div class="section" id="hidden-dynamics">
<span id="recipes-hidden-dynamics"></span><h2><a class="toc-backref" href="#id18">Hidden Dynamics</a><a class="headerlink" href="#hidden-dynamics" title="Permalink to this headline">¶</a></h2>
<a class="reference internal" href="quickstart.html"<span class="std-ref">prev</span></a>, <a class="reference internal" href="index.html#top"><span class="std std-ref">top</span></a>, <a class="reference internal" href="introduction.html"><span class="std std-ref">next</span></a></div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo">
<a href="index.html">
  <img class="logo_a" src="_static/miros_a.svg" width="250" alt="Logo" >
</a>
</p>
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Recipes</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#context-and-terminology">Context and Terminology</a></li>
<li><a class="reference internal" href="#reflection-and-logging">Reflection and Logging</a><ul>
<li><a class="reference internal" href="#souped-up-spy">Souped Up Spy</a></li>
<li><a class="reference internal" href="#souped-up-state-name-reflection">Souped Up State Name Reflection</a></li>
<li><a class="reference internal" href="#simplifying-the-inner-injector-functions">Simplifying the Inner Injector Functions</a></li>
<li><a class="reference internal" href="#reading-the-log-file">Reading the Log File</a></li>
</ul>
</li>
<li><a class="reference internal" href="#building-a-subregion">Building a Subregion</a></li>
<li><a class="reference internal" href="#writing-wtf-events-across-regions">Writing WTF Events Across Regions</a><ul>
<li><a class="reference internal" href="#e-wtf-events">E WTF Events</a></li>
<li><a class="reference internal" href="#e0-wtf-event">E0 WTF Event</a></li>
<li><a class="reference internal" href="#e1-wtf-event">E1 WTF Event</a></li>
<li><a class="reference internal" href="#e2-wtf-event">E2 WTF Event</a></li>
<li><a class="reference internal" href="#c-wtf-events">C WTF Events</a></li>
<li><a class="reference internal" href="#c0-wtf-event">C0 WTF Event</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hidden-dynamics">Hidden Dynamics</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="quickstart.html" title="previous chapter">Quick Start</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/recipes.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Scott Volk.
      
      |
      <a href="_sources/recipes.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>